import sys, os
import subprocess

def cmdlet_exists(cmdlet_name):
    cmd = ['powershell.exe', f'-Command', f'Get-Command {cmdlet_name}']
    try:
        output = subprocess.check_output(cmd, stderr=subprocess.STDOUT)
    except subprocess.CalledProcessError:
        return False
    return True


def setup():
    # Test if the Get-Service cmdlet exists
    if cmdlet_exists('Get-Service'):
        print('Get-Service cmdlet exists')
    else:
        print('Get-Service cmdlet does not exist')

    # Test if the nonexistent cmdlet exists
    if cmdlet_exists('Invoke-PS2EXE '):
        print('Invoke-PS2EXE  cmdlet exists')
        return True
    else:
        print('Installing Invoke-PS2EXE cmdlet')
        os.system("powershell.exe Install-Module ps2exe")
        if cmdlet_exists('Invoke-PS2EXE '):
            print('Invoke-PS2EXE  cmdlet exists')
            return True
    
    return False



def usage_details():
    print("Usage Example 1: python3 create_init_exe.py <path to file> <output file name>\n")
    print("Usage Example 2: create_init_exe.exe <path to file> <output file name>")


if __name__ == '__main__':
    if len(sys.argv) != 3:
        print("CMD Line Args Error")
        usage_details()
        sys.exit()
    
    if not os.path.exists(sys.argv[1]):
        print("Input File Path Not Found")
        usage_details()

    if not setup():
        print("Unable to create EXE from ps1 file")
        sys.exit()
    
    os.system(f"powershell.exe  Invoke-PS2EXE {sys.argv[1]} {sys.argv[2]}")